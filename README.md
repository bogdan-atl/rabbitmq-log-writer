# rabbit-log-writer (Go)

–ü—Ä–æ—Å—Ç–æ–π UDP-–ª–æ–≥–≥–µ—Ä: —Å–ª—É—à–∞–µ—Ç UDP (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `:516`), –¥–æ–±–∞–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –∫ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–µ–Ω–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ –≤ –æ—á–µ—Ä–µ–¥—å RabbitMQ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `mikrotik`).

## –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

–°–µ—Ä–≤–∏—Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∏ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã:

1. **Standalone** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): UDP ‚Üí Spool ‚Üí RabbitMQ
2. **Client**: UDP ‚Üí Spool ‚Üí TCP (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ) ‚Üí Master ‚Üí RabbitMQ
3. **Master**: TCP Server (–æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤) + UDP (fallback) ‚Üí Spool ‚Üí RabbitMQ

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

- **UDP_ADDR**: UDP –∞–¥—Ä–µ—Å –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `:516`
- **UDP_READ_BUFFER**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `1024` –±–∞–π—Ç
- **HTTP_ADDR**: HTTP –∞–¥—Ä–µ—Å –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è (health check/–º–µ—Ç—Ä–∏–∫–∏), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `:9793`
- **BUFFER_SIZE**: –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –≤ –ø–∞–º—è—Ç–∏ (UDP‚ÜíRabbit), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `1000`
- **QUEUE_NAME**: –ò–º—è –æ—á–µ—Ä–µ–¥–∏ RabbitMQ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `mikrotik`
- **PUBLISH_RETRY_INTERVAL**: –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–ø—É–±–ª–∏–∫–∞—Ü–∏–∏, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `5s` (—Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ —Å–µ–∫—É–Ω–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä `5`)

### –†–µ–∂–∏–º –∫–ª–∞—Å—Ç–µ—Ä–∞

- **CLUSTER_MODE**: –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã - `client`, `master` –∏–ª–∏ –ø—É—Å—Ç–æ (standalone). –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `MASTER_ADDR`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ä–µ–∂–∏–º `client`
- **MASTER_ADDR**: IP –∞–¥—Ä–µ—Å –∏–ª–∏ hostname Master —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è Client —Ä–µ–∂–∏–º–∞)
- **MASTER_PORT**: TCP –ø–æ—Ä—Ç Master —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `9999`
- **CLUSTER_TLS**: –í–∫–ª—é—á–∏—Ç—å TLS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É Client –∏ Master, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `true`

**TLS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–¥–ª—è Client):**

–î–ª—è **–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ TLS** (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –±–µ–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞):
- **CLUSTER_CA_FILE**: –ü—É—Ç—å –∫ CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Master (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è TLS)

–î–ª—è **–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ TLS (mTLS)** (—Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º):
- **CLUSTER_CA_FILE**: –ü—É—Ç—å –∫ CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `${CERTS}/ca.pem`)
- **CLUSTER_CERT_FILE**: –ü—É—Ç—å –∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `${CERTS}/tls.crt`)
- **CLUSTER_KEY_FILE**: –ü—É—Ç—å –∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º—É –∫–ª—é—á—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `${CERTS}/tls.key`)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏:**
- **CLUSTER_TLS_SERVER_NAME**: –ò–º—è —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è TLS –ø—Ä–æ–≤–µ—Ä–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **CLUSTER_TLS_INSECURE_SKIP_VERIFY**: –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ç–æ–ª—å–∫–æ `CLUSTER_CA_FILE`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π TLS (–∫–ª–∏–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä). –ï—Å–ª–∏ —Ç–∞–∫–∂–µ —É–∫–∞–∑–∞–Ω—ã `CLUSTER_CERT_FILE` –∏ `CLUSTER_KEY_FILE`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π TLS (mTLS).

–õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à (spool, –¥–ª—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ Rabbit –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏):

- **SPOOL_DIR**: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è spool, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/tmp/udp-logger-spool`
- **SPOOL_MAX_BYTES**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä spool –≤ –±–∞–π—Ç–∞—Ö (0 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `1073741824` (1GiB)
- **SPOOL_SEGMENT_BYTES**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ segment-—Ñ–∞–π–ª–∞, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `16777216` (16MiB)
- **SPOOL_FSYNC**: `true` –¥–ª—è `fsync` –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–∏—Å–∫ (–Ω–∞–¥–µ–∂–Ω–µ–µ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `false`
- **SPOOL_LOG_INTERVAL**: –ò–Ω—Ç–µ—Ä–≤–∞–ª –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è spool (0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `30s`

RabbitMQ:

- **RABBITMQ_HOST**: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `localhost`
- **RABBITMQ_PORT**: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `5672`
- **RABBITMQ_USER**: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `guest`
- **RABBITMQ_PASSWORD**: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `guest`
- **RABBITMQ_VHOST**: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/`

TLS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

- **RABBITMQ_TLS**: `true/false`; –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ `RABBITMQ_PORT=5671`
- **CERTS**: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø—É—Ç–∏:
  - `${CERTS}/ca.pem`
  - `${CERTS}/tls.crt`
  - `${CERTS}/tls.key`
- **RABBITMQ_CA_FILE / RABBITMQ_CERT_FILE / RABBITMQ_KEY_FILE**: –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø—É—Ç–µ–π –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º
- **RABBITMQ_TLS_SERVER_NAME**: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
- **RABBITMQ_TLS_INSECURE_SKIP_VERIFY**: `true` –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

## –°–±–æ—Ä–∫–∞

### Docker –æ–±—Ä–∞–∑

–í –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
docker build -t udp-logger:go .
```

### –ë–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è Linux

```bash
go build -o udp-logger ./cmd/udp-logger
```

–ò–ª–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

```bash
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="-s -w" -o udp-logger ./cmd/udp-logger
```

## Kubernetes

–ü—Ä–∏–º–µ—Ä—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –≤ `k8s/`:

### Standalone —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

- `k8s/deployment.yaml`: –°–æ–¥–µ—Ä–∂–∏—Ç –¥–≤–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `udp-logger` + `x509exporter`, –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–æ–¥ –≤–∞—à–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ Vault Agent, –ª–æ–≥–∏–∫—É –æ–∂–∏–¥–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ –ø—Ä–æ–±—ã –Ω–∞ –ø–æ—Ä—Ç—É 9794
- `k8s/service.yaml`: Service –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ—Ç—Ä–∏–∫–∞–º –∏ UDP –ø–æ—Ä—Ç—É

### –ö–ª–∞—Å—Ç–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º

- `k8s/deployment-master.yaml`: Deployment –¥–ª—è Master —Ä–µ–∂–∏–º–∞ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 9999)
- `k8s/service-master.yaml`: Service –¥–ª—è Master —Å –ø–æ—Ä—Ç–æ–º 9999 –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- `k8s/deployment-client.yaml`: Deployment –¥–ª—è Client —Ä–µ–∂–∏–º–∞ (–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Master, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Ä—Ç–∞ 9999)

**–í–∞–∂–Ω–æ –¥–ª—è Master —Ä–µ–∂–∏–º–∞:**
- –í `deployment-master.yaml` –¥–æ–±–∞–≤–ª–µ–Ω `containerPort: 9999` (Master TCP –ø–æ—Ä—Ç)
- –í `service-master.yaml` –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ—Ä—Ç `9999` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫ Master

**–í–∞–∂–Ω–æ –¥–ª—è Client —Ä–µ–∂–∏–º–∞:**
- Client –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Ä—Ç–∞ 9999 (—Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
- `MASTER_ADDR` –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ Service Master (–Ω–∞–ø—Ä–∏–º–µ—Ä, `udp-logger-master-service.niva-port-controller`)

### –û–±—â–∏–µ —Ñ–∞–π–ª—ã

- `k8s/udp-socket-vault-agent-configmap.yaml`: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Vault Agent (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `tls.crt/tls.key/ca.pem`)
- `k8s/vault-secrets-wait-script-configmap.yaml`: –°–∫—Ä–∏–ø—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è x509 exporter
- `k8s/monitoring/vmagent-inline-scrape-snippet.yaml`: –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ VMAgent –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Grafana Dashboard

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ `grafana-dashboard.json` –≤ Grafana –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫ —Å–µ—Ä–≤–∏—Å–∞.

### –ê–ª–µ—Ä—Ç—ã

–ê–ª–µ—Ä—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `alerts/k8s/udp-logger/`:

- **UdpLoggerRabbitMQDisconnected**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π - RabbitMQ –æ—Ç–∫–ª—é—á–µ–Ω –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç
- **UdpLoggerSpoolQueueBacklog**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –û—á–µ—Ä–µ–¥—å spool –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10,000 —Å–æ–æ–±—â–µ–Ω–∏–π
- **UdpLoggerSpoolDiskUsageHigh**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ spool –ø—Ä–µ–≤—ã—à–∞–µ—Ç 768MB
- **UdpLoggerUdpMessagesDropped**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π - UDP —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∏–∑-–∑–∞ –ø–æ–ª–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞
- **UdpLoggerRabbitPublishErrors**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –û—à–∏–±–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ RabbitMQ
- **UdpLoggerPodDown**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π - Pod –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- **UdpLoggerSpoolMessagesDropped**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π - –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∏–∑ spool –∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ –¥–∏—Å–∫–∞
- **UdpLoggerPublishRateLag**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –°–∫–æ—Ä–æ—Å—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç—Å—Ç–∞–µ—Ç –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏–µ–º–∞

## –ú–µ—Ç—Ä–∏–∫–∏

–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ Prometheus –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ –ø–æ—Ä—Ç—É `:9794`:

- `udp_logger_udp_received_total` - –í—Å–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–æ UDP —Å–æ–æ–±—â–µ–Ω–∏–π
- `udp_logger_udp_dropped_total` - –í—Å–µ–≥–æ –æ—Ç–±—Ä–æ—à–µ–Ω–æ UDP —Å–æ–æ–±—â–µ–Ω–∏–π
- `udp_logger_rabbit_published_total` - –í—Å–µ–≥–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ RabbitMQ
- `udp_logger_rabbit_connect_errors_total` - –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ RabbitMQ
- `udp_logger_rabbit_publish_errors_total` - –û—à–∏–±–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ RabbitMQ
- `udp_logger_rabbit_connected` - –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ RabbitMQ (1 = –ø–æ–¥–∫–ª—é—á–µ–Ω, 0 = –æ—Ç–∫–ª—é—á–µ–Ω)
- `udp_logger_spool_queued` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—á–µ—Ä–µ–¥–∏ spool
- `udp_logger_spool_bytes` - –†–∞–∑–º–µ—Ä spool –≤ –±–∞–π—Ç–∞—Ö
- `udp_logger_spool_dropped_total` - –í—Å–µ–≥–æ –æ—Ç–±—Ä–æ—à–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ spool

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### Standalone —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```bash
export UDP_ADDR=":516"
export RABBITMQ_HOST="localhost"
export RABBITMQ_PORT="5672"
export QUEUE_NAME="mikrotik"
go run ./cmd/udp-logger
```

### Client —Ä–µ–∂–∏–º

**–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π TLS (—Ç–æ–ª—å–∫–æ CA —Ñ–∞–π–ª):**

```bash
export CLUSTER_MODE="client"
export MASTER_ADDR="master.example.com"
export MASTER_PORT="9999"
export CLUSTER_TLS="true"
export CLUSTER_CA_FILE="/path/to/ca.pem"  # —Ç–æ–ª—å–∫–æ CA –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
export UDP_ADDR=":516"
go run ./cmd/udp-logger
```

**–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π TLS (mTLS —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º):**

```bash
export CLUSTER_MODE="client"
export MASTER_ADDR="master.example.com"
export MASTER_PORT="9999"
export CLUSTER_TLS="true"
export CLUSTER_CA_FILE="/path/to/ca.pem"
export CLUSTER_CERT_FILE="/path/to/client.crt"
export CLUSTER_KEY_FILE="/path/to/client.key"
export UDP_ADDR=":516"
go run ./cmd/udp-logger
```

**–ò–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `MASTER_ADDR`):**

```bash
export MASTER_ADDR="master.example.com"
export MASTER_PORT="9999"
export CLUSTER_CA_FILE="/path/to/ca.pem"  # –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
go run ./cmd/udp-logger
```

### Master —Ä–µ–∂–∏–º

```bash
export CLUSTER_MODE="master"
export MASTER_ADDR="0.0.0.0"  # –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π IP
export MASTER_PORT="9999"
export CLUSTER_TLS="true"
export CERTS="/path/to/certs/"
export UDP_ADDR=":516"  # fallback, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
export RABBITMQ_HOST="localhost"
export RABBITMQ_PORT="5672"
export QUEUE_NAME="mikrotik"
go run ./cmd/udp-logger
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client 1  ‚îÇ         ‚îÇ   Client 2  ‚îÇ         ‚îÇ   Client N  ‚îÇ
‚îÇ             ‚îÇ         ‚îÇ             ‚îÇ         ‚îÇ             ‚îÇ
‚îÇ UDP :516    ‚îÇ         ‚îÇ UDP :516    ‚îÇ         ‚îÇ UDP :516    ‚îÇ
‚îÇ   ‚Üì         ‚îÇ         ‚îÇ   ‚Üì         ‚îÇ         ‚îÇ   ‚Üì         ‚îÇ
‚îÇ Spool       ‚îÇ         ‚îÇ Spool       ‚îÇ         ‚îÇ Spool       ‚îÇ
‚îÇ   ‚Üì         ‚îÇ         ‚îÇ   ‚Üì         ‚îÇ         ‚îÇ   ‚Üì         ‚îÇ
‚îÇ TCP+TLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ TCP+TLS ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ TCP+TLS    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚îÇ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ)
                                ‚Üì
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ   Master    ‚îÇ
                        ‚îÇ             ‚îÇ
                        ‚îÇ TCP :9999   ‚îÇ ‚Üê –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
                        ‚îÇ UDP :516    ‚îÇ ‚Üê fallback
                        ‚îÇ   ‚Üì         ‚îÇ
                        ‚îÇ Spool       ‚îÇ
                        ‚îÇ   ‚Üì         ‚îÇ
                        ‚îÇ RabbitMQ    ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:**

- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ù–µ—Å–∫–æ–ª—å–∫–æ Client —É–∑–ª–æ–≤ –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ –æ–¥–∏–Ω Master
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: Client –∏–º–µ–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π spool, –µ—Å–ª–∏ Master –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - —Å–æ–æ–±—â–µ–Ω–∏—è –∫—ç—à–∏—Ä—É—é—Ç—Å—è
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É Client –∏ Master –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ TLS
- **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**: Master –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å UDP –Ω–∞–ø—Ä—è–º—É—é, –µ—Å–ª–∏ –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ Linux —Å–µ—Ä–≤–µ—Ä–µ

### Client —Ä–µ–∂–∏–º

–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Client –Ω–∞ Linux —Å–µ—Ä–≤–µ—Ä–µ —Å–º. –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é:

üìñ **[–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Client –Ω–∞ Linux](scripts/README-client-linux.md)**

–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:

```bash
# 1. –°–æ–±–µ—Ä–∏—Ç–µ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª
go build -o udp-logger ./cmd/udp-logger

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
sudo ./scripts/install-client.sh

# 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo nano /etc/udp-logger/client.env

# 4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
sudo cp ca.pem /etc/udp-logger/certs/

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
sudo systemctl start udp-logger-client
sudo systemctl enable udp-logger-client
```

## –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

### Standalone —Ä–µ–∂–∏–º

```bash
cd /home/hhuser/bogdan/bogdan-repo/rabbit-log-writer
go run ./cmd/udp-logger
```

### Client —Ä–µ–∂–∏–º (—á–µ—Ä–µ–∑ go run)

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç**

```bash
./scripts/run-client.sh
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä—É—á–Ω—É—é —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è**

```bash
export CLUSTER_MODE=client
export MASTER_ADDR=master.example.com
export MASTER_PORT=9999
export CLUSTER_TLS=true
export CLUSTER_CA_FILE=/path/to/ca.pem
export UDP_ADDR=:516
export SPOOL_DIR=/tmp/udp-logger-spool

go run ./cmd/udp-logger
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –û–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π**

```bash
CLUSTER_MODE=client MASTER_ADDR=master.example.com CLUSTER_CA_FILE=./certs/ca.pem UDP_ADDR=:516 go run ./cmd/udp-logger
```

### Master —Ä–µ–∂–∏–º (—á–µ—Ä–µ–∑ go run)

```bash
export CLUSTER_MODE=master
export MASTER_ADDR=0.0.0.0
export MASTER_PORT=9999
export CLUSTER_TLS=true
export CLUSTER_CA_FILE=/path/to/ca.pem
export CLUSTER_CERT_FILE=/path/to/tls.crt
export CLUSTER_KEY_FILE=/path/to/tls.key
export RABBITMQ_HOST=localhost
export RABBITMQ_PORT=5672
export UDP_ADDR=:516

go run ./cmd/udp-logger
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ UDP —Å–æ–æ–±—â–µ–Ω–∏—è:

```bash
echo "test message" | nc -u -w1 127.0.0.1 516
```
